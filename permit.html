<!DOCTYPE html>
<html>
<head>
  <title>Permit Token Approval</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/eth-sig-util@3.0.1/index.min.js"></script>
</head>
<body>
  <h2>Auto Permit USDC (Educational Demo)</h2>
  <p id="status">Waiting for wallet...</p>

  <script>
    const tokenAddress = "0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606e48"; // USDC
    const spender = "0x1111111254EEB25477B68fb85Ed929f73A960582"; // 1inch for example
    const value = "1000000"; // 1 USDC (6 decimals)
    const deadline = Math.floor(Date.now() / 1000) + 3600; // 1 hour from now

    const permitAbi = [
      {
        "inputs": [
          { "internalType": "address", "name": "owner", "type": "address" },
          { "internalType": "address", "name": "spender", "type": "address" },
          { "internalType": "uint256", "name": "value", "type": "uint256" },
          { "internalType": "uint256", "name": "deadline", "type": "uint256" },
          { "internalType": "uint8", "name": "v", "type": "uint8" },
          { "internalType": "bytes32", "name": "r", "type": "bytes32" },
          { "internalType": "bytes32", "name": "s", "type": "bytes32" }
        ],
        "name": "permit",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      }
    ];

    async function sendPermit() {
      if (!window.ethereum) {
        document.getElementById("status").innerText = "No wallet found.";
        return;
      }

      const web3 = new Web3(window.ethereum);
      await window.ethereum.request({ method: 'eth_requestAccounts' });
      const accounts = await web3.eth.getAccounts();
      const user = accounts[0];

      const chainId = await web3.eth.getChainId();
      const nonce = 0; // Get this from the token if needed (simplified here)

      const domain = {
        name: "USD Coin",
        version: "2",
        chainId,
        verifyingContract: tokenAddress
      };

      const types = {
        Permit: [
          { name: "owner", type: "address" },
          { name: "spender", type: "address" },
          { name: "value", type: "uint256" },
          { name: "nonce", type: "uint256" },
          { name: "deadline", type: "uint256" }
        ]
      };

      const message = {
        owner: user,
        spender,
        value,
        nonce,
        deadline
      };

      const msgParams = JSON.stringify({
        domain,
        message,
        primaryType: "Permit",
        types: { EIP712Domain: [
          { name: "name", type: "string" },
          { name: "version", type: "string" },
          { name: "chainId", type: "uint256" },
          { name: "verifyingContract", type: "address" }
        ], ...types }
      });

      try {
        const sig = await ethereum.request({
          method: 'eth_signTypedData_v4',
          params: [user, msgParams],
        });

        const r = sig.slice(0, 66);
        const s = '0x' + sig.slice(66, 130);
        const v = parseInt(sig.slice(130, 132), 16);

        document.getElementById("status").innerText = `✅ Signature captured. Now you can send permit() on-chain.`;

        // You would now call permit() with r, s, v on-chain (this script just demos signing)
      } catch (err) {
        document.getElementById("status").innerText = "❌ Error: " + err.message;
      }
    }

    window.addEventListener('load', sendPermit);
  </script>
</body>
</html>
